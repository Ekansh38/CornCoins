<!DOCTYPE html>
<html>
<head>
    <title>Corn Coin Exchange</title>
</head>
<body>
    <h1>📈 Corn Coin Market</h1>
    
    <!-- ✅ Display the Logged-in User -->
    <h2>Welcome, <span id="user-name">Loading...</span>! 👋</h2>
    
    <h3>Balance: $<span id="balance">Loading...</span></h3>
    <h3>Corn Coins: <span id="corn-coins">Loading...</span></h3>

    <a href="/logout/">Logout</a>

    <!-- ✅ Display the Market Price -->
    <h3>Market Price: $<span id="market-price">Loading...</span></h3>
    
    <h3>Place Order</h3>
    <form id="trade-form">
        <label>Order Type:</label>
        <select id="order-type" name="order_type">
            <option value="BUY">BUY</option>
            <option value="SELL">SELL</option>
        </select>

        <label>Amount:</label>
        <input type="number" id="amount" name="amount" required>
        
        <label>Price:</label>
        <input type="number" id="price" name="price" required>

        <button type="submit">Submit</button>
    </form>

    <h3>Transaction Response:</h3>
    <p id="response"></p>

    <h3>Order Book</h3>
    <h4>Buy Orders</h4>
    <ul id="buy-orders"></ul>

    <h4>Sell Orders</h4>
    <ul id="sell-orders"></ul>

        <h3>Transaction History</h3>
    <table border="1">
        <tr>
            <th>Buyer</th>
            <th>Seller</th>
            <th>Amount</th>
            <th>Price</th>
            <th>Timestamp</th>
        </tr>
        {% for trade in transactions %}
        <tr>
            <td>{{ trade.buyer.name }}</td>
            <td>{{ trade.seller.name }}</td>
            <td>{{ trade.amount }} CC</td>
            <td>${{ trade.price }}</td>
            <td>{{ trade.timestamp }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5">No trades yet.</td>
        </tr>
        {% endfor %}
    </table>


    <script>
        // ✅ Load user data
        function loadUserData() {
            fetch("/get-user/")
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    window.location.href = "/login/";
                } else {
                    document.getElementById("user-name").innerText = data.name;
                    document.getElementById("balance").innerText = data.balance_credits;
                    document.getElementById("corn-coins").innerText = data.corn_coins;
                }
            })
            .catch(error => console.error("Error loading user data:", error));
        }

        // ✅ Load order book instantly & update every 5 seconds
        function loadOrderBook() {
            fetch("/orders/")
            .then(response => response.json())
            .then(data => {
                document.getElementById("market-price").innerText = data.market_price;

                let buyOrdersList = document.getElementById("buy-orders");
                let sellOrdersList = document.getElementById("sell-orders");

                if (!buyOrdersList || !sellOrdersList) {
                    console.error("Buy or sell orders list elements not found.");
                    return;
                }

                // ✅ Clear existing orders before updating
                buyOrdersList.innerHTML = "";
                sellOrdersList.innerHTML = "";

                // ✅ Populate Buy Orders
                data.buy_orders.forEach(order => {
                    let listItem = document.createElement("li");
                    listItem.innerText = `BUY ${order.amount} CC @ $${order.price} (by ${order.user})`;
                    buyOrdersList.appendChild(listItem);
                });

                // ✅ Populate Sell Orders
                data.sell_orders.forEach(order => {
                    let listItem = document.createElement("li");
                    listItem.innerText = `SELL ${order.amount} CC @ $${order.price} (by ${order.user})`;
                    sellOrdersList.appendChild(listItem);
                });

            })
            .catch(error => console.error("Error loading order book:", error));
        }

        // ✅ Handle form submission
        document.getElementById("trade-form").addEventListener("submit", function(event) {
            event.preventDefault();

            let orderType = document.getElementById("order-type").value;
            let amount = document.getElementById("amount").value;
            let price = document.getElementById("price").value;

            if (!amount || !price) {
                document.getElementById("response").innerText = "❌ Please enter both amount and price!";
                return;
            }

            let formData = {
                order_type: orderType,
                amount: amount,
                price: price
            };

            console.log("🔍 Sending Order Data:", formData);  // ✅ Debugging

            fetch("/trade/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("response").innerText = data.message || data.error;
                loadUserData();  // ✅ Refresh user balance after order
                loadOrderBook(); // ✅ Refresh order book after placing order
            })
            .catch(error => console.error("Fetch Error:", error));
        });

        // ✅ Load user, order book & price immediately & auto-refresh every 5s
        document.addEventListener("DOMContentLoaded", () => {
            loadUserData();
            loadOrderBook();
            setInterval(loadOrderBook, 5000);
        });
    </script>

</body>
</html>
