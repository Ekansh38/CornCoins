{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corn Coin Exchange</title>

    <!-- Bootstrap & CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="/">üåΩ Corn Coin Exchange</a>
        <a class="navbar-brand" href="/mine/">‚õèÔ∏è Mine</a>
        <a class="navbar-brand" href="/graph/">üìà Graph</a>
        <a class="navbar-brand" href="/bank-transfer/">üè¶ Bank Transfer</a>
    </div>
</nav>

<!-- Main Content -->
<div class="container mt-4">
    <div class="row">
        <!-- ‚úÖ User Info -->
        <div class="col-12 mb-3">
            <div class="alert alert-info text-center">
                <h4>Welcome, <span id="user-name">Loading...</span>! üëã</h4>
                <p><strong>Balance:</strong> $<span id="balance">Loading...</span></p>
                <p><strong>Corn Coins:</strong> <span id="corn-coins">Loading...</span> CC</p>
                <a href="/logout/" class="btn btn-danger btn-sm">Logout</a>
            </div>
        </div>

        <!-- Left Column: Order Form -->
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-primary">Place Order</h4>
                    <form id="trade-form">
                        <div class="mb-3">
                            <label class="form-label">Order Type:</label>
                            <select id="order-type" name="order_type" class="form-select">
                                <option value="BUY">BUY</option>
                                <option value="SELL">SELL</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Amount:</label>
                            <input type="number" id="amount" name="amount" step="any" class="form-control" required>
                        </div>

                        <!-- ‚úÖ Toggle for Optimal Price -->
                        <div class="mb-3 form-check">
                            <input type="checkbox" id="use-optimal-price" class="form-check-input">
                            <label class="form-check-label" for="use-optimal-price">Use Optimal Price</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Price per Coin:</label>
                            <input type="number" id="price" name="price" step="any" class="form-control" required>
                        </div>

                        <p><strong>Total Cost:</strong> $<span id="total-cost">0.00</span></p>

                        <button type="submit" class="btn btn-success w-100">Submit Order</button>
                    </form>
                </div>
            </div>
            <div id="order-response" class="alert d-none mt-3"></div>
        </div>

        <!-- Right Column: Order Book -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-primary">Market Price: $<span id="market-price">Loading...</span></h4>
                    
                    <h5 class="text-success">Buy Orders</h5>
                    <ul class="list-group mb-3" id="buy-orders"></ul>

                    <h5 class="text-danger">Sell Orders</h5>
                    <ul class="list-group" id="sell-orders"></ul>
                </div>
            </div>
        </div>



        <!-- ‚úÖ User Orders Section -->
<div class="card shadow-sm mt-4">
    <div class="card-body">
        <h4 class="card-title text-primary">Your Orders</h4>
        <ul class="list-group" id="user-orders">
            <li class="list-group-item text-center">Loading...</li>
        </ul>
    </div>



</div>



    </div>
</div>


            <!-- ‚úÖ Transaction History (Restored) -->
    <div class="card shadow-sm mt-4">
        <div class="card-body">
            <h4 class="card-title text-primary">Transaction History</h4>
            <table class="table table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>Buyer</th>
                        <th>Seller</th>
                        <th>Amount</th>
                        <th>Price</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody id="transaction-history">
                    {% for trade in transactions %}
                    <tr>
                        <td>{{ trade.buyer.name }}</td>
                        <td>{{ trade.seller.name }}</td>
                        <td>{{ trade.amount }} CC</td>
                        <td>${{ trade.price }}</td>
                        <td>{{ trade.timestamp|date:"Y-m-d H:i" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No trades yet.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ‚úÖ Load User Orders
    function loadUserOrders() {
        fetch("/user-orders/")
        .then(response => response.json())
        .then(data => {
            let ordersList = document.getElementById("user-orders");
            ordersList.innerHTML = "";

            if (data.orders.length === 0) {
                ordersList.innerHTML = `<li class="list-group-item text-center">No active orders.</li>`;
                return;
            }

            data.orders.forEach(order => {
                let listItem = document.createElement("li");
                listItem.className = `list-group-item d-flex justify-content-between align-items-center ${
                    order.order_type === "BUY" ? "list-group-item-success" : "list-group-item-danger"
                }`;

                listItem.innerHTML = `
                    <strong>${order.amount} CC</strong> @ <strong>$${order.price.toFixed(2)}</strong> 
                    (${order.order_type})
                    <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.id})">‚ùå Delete</button>
                `;
                ordersList.appendChild(listItem);
            });
        })
        .catch(error => console.error("üö® Error loading user orders:", error));
    }
    // ‚úÖ Delete Order Function
    function deleteOrder(orderId) {
        fetch(`/delete-order/${orderId}/`, { method: "POST" })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUserOrders(); // Refresh orders after deleting
                loadOrderBook();  // Refresh market orders
            } else {
                alert("‚ùå " + data.error);
            }
        })
        .catch(error => console.error("üö® Error deleting order:", error));
    }

    // ‚úÖ Load user orders on page load
    document.addEventListener("DOMContentLoaded", loadUserOrders);
    let lowestSellOrders = [];
    let highestBuyOrders = [];



    function loadUserData() {
        fetch("/get-user/")
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                window.location.href = "/login/";
            } else {
                document.getElementById("user-name").innerText = data.name;
                document.getElementById("balance").innerText = data.balance_credits.toFixed(2);
                document.getElementById("corn-coins").innerText = data.corn_coins.toFixed(2);
            }
        })
        .catch(error => console.error("Error loading user data:", error));
    }

function loadOrderBook() {
    fetch("/orders/")
        .then(response => response.json())
        .then(data => {
            console.log("üìú Loaded Order Book:", data);

            // ‚úÖ Update Market Price
            document.getElementById("market-price").innerText = data.market_price.toFixed(2);;

            let buyOrdersList = document.getElementById("buy-orders");
            let sellOrdersList = document.getElementById("sell-orders");

            if (!buyOrdersList || !sellOrdersList) {
                console.error("‚ùå Order book elements not found.");
                return;
            }

            // ‚úÖ Clear existing orders
            buyOrdersList.innerHTML = "";
            sellOrdersList.innerHTML = "";

            // ‚úÖ Store sorted orders for pricing calculations
            lowestSellOrders = [...data.sell_orders]
                .filter(order => order.amount > 0) // Ignore invalid orders
                .sort((a, b) => a.price - b.price); // Lowest first

            highestBuyOrders = [...data.buy_orders]
                .filter(order => order.amount > 0) // Ignore invalid orders
                .sort((a, b) => b.price - a.price); // Highest first

            // ‚úÖ Display Buy Orders (Highest Price First)
            highestBuyOrders.forEach(order => {
                let listItem = document.createElement("li");
                listItem.className = "list-group-item list-group-item-success";
                listItem.innerHTML = `<strong>${order.user}</strong> wants to <strong>BUY</strong> ${order.amount} CC @ <strong>$${order.price.toFixed(2)}</strong>`;
                buyOrdersList.appendChild(listItem);
            });

            // ‚úÖ Display Sell Orders (Lowest Price First)
            lowestSellOrders.forEach(order => {
                let listItem = document.createElement("li");
                listItem.className = "list-group-item list-group-item-danger";
                listItem.innerHTML = `<strong>${order.user}</strong> wants to <strong>SELL</strong> ${order.amount} CC @ <strong>$${order.price.toFixed(2)}</strong>`;
                sellOrdersList.appendChild(listItem);
            });

            console.log("‚úÖ Buy Orders:", highestBuyOrders);
            console.log("‚úÖ Sell Orders:", lowestSellOrders);
        })
        .catch(error => console.error("üö® Error loading order book:", error));
}
function calculateOptimalPrice() {
    console.log("üîç Calculating optimal price...");

    let orderType = document.getElementById("order-type").value;
    let amount = parseFloat(document.getElementById("amount").value) || 0;
    let priceField = document.getElementById("price");
    let totalCost = 0;
    let remainingAmount = amount;

    if (!amount || amount <= 0) return;

    if (orderType === "BUY" && lowestSellOrders.length > 0) {
        for (let order of lowestSellOrders) {
            let tradeAmount = Math.min(order.amount, remainingAmount);
            totalCost += tradeAmount * order.price;
            remainingAmount -= tradeAmount;

            console.log(`‚úÖ Matching ${tradeAmount} CC at $${order.price}, Remaining: ${remainingAmount}`);

            if (remainingAmount <= 0) break; // ‚úÖ Ensures exact match breaks loop
        }    } else if (orderType === "SELL" && highestBuyOrders.length > 0) {
        for (let order of highestBuyOrders) {
            let tradeAmount = Math.min(order.amount, remainingAmount);
            totalCost += tradeAmount * order.price;
            remainingAmount -= tradeAmount;
            if (remainingAmount <= 0) break;
        }
    }

    // ‚úÖ Set price field correctly
    if (remainingAmount > 0) {
        priceField.value = ""; // If there's not enough liquidity, leave empty
        document.getElementById("total-cost").innerText = "Not enough liquidity!";
    } else {
        priceField.value = (totalCost / amount).toFixed(2);
        document.getElementById("total-cost").innerText = totalCost.toFixed(2);
    }

    console.log("‚úÖ Optimal price:", totalCost / amount, "Total cost:", totalCost);
}
function updateTotalCost() {
    let amount = parseFloat(document.getElementById("amount").value) || 0;
    let price = parseFloat(document.getElementById("price").value) || 0;

    if (amount > 0 && price > 0) {
        document.getElementById("total-cost").innerText = (amount * price).toFixed(2);
    } else {
        document.getElementById("total-cost").innerText = "0.00";
    }
}

// üîπ Auto-update total cost when user types in amount or price
document.getElementById("amount").addEventListener("input", updateTotalCost);
document.getElementById("price").addEventListener("input", updateTotalCost);
    function handleOrderSubmission(event) {
        event.preventDefault();

        let orderType = document.getElementById("order-type").value;
        let amount = parseFloat(document.getElementById("amount").value);
        let price = parseFloat(document.getElementById("price").value);
        let responseBox = document.getElementById("order-response");

        if (!amount || amount <= 0) {
            responseBox.className = "alert alert-danger mt-3";
            responseBox.innerText = "‚ùå Order amount must be greater than 0.";
            responseBox.classList.remove("d-none");
            return;
        }

        let formData = { order_type: orderType, amount: amount, price: price };

        fetch("/trade/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            responseBox.className = data.error ? "alert alert-danger mt-3" : "alert alert-success mt-3";
            responseBox.innerText = data.error || `‚úÖ ${data.message}`;
            loadUserData();
            loadOrderBook();
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadUserData();
        loadOrderBook();
        setInterval(loadOrderBook, 5000);

        document.getElementById("use-optimal-price").addEventListener("change", function() {
            if (this.checked) {
                calculateOptimalPrice();
            }
        });

        document.getElementById("amount").addEventListener("input", function() {
            if (document.getElementById("use-optimal-price").checked) {
                calculateOptimalPrice();
            }
        });

        document.getElementById("order-type").addEventListener("change", function() {
            if (document.getElementById("use-optimal-price").checked) {
                calculateOptimalPrice();
            }
        });
    });

    document.getElementById("trade-form").addEventListener("submit", function(event) {
    event.preventDefault();

    let orderType = document.getElementById("order-type").value;
    let amount = parseFloat(document.getElementById("amount").value);
    let price = parseFloat(document.getElementById("price").value);
    let responseBox = document.getElementById("order-response");

	if (!amount || amount == 0) {
        responseBox.className = "alert alert-danger mt-3";
        responseBox.innerText = "‚ùå Order amount must greater than 0.0CC.";
        responseBox.classList.remove("d-none");
        setTimeout(() => responseBox.classList.add("d-none"), 3000);
        return;
    }

    if (!price) return;

    let formData = { 
        order_type: orderType, // Ensures the correct order type is sent
        amount: amount, 
        price: price 
    };

    console.log("üîç Sending Order Data:", formData);  // Debugging

    // Show "Processing Order..." immediately
    responseBox.className = "alert alert-warning mt-3";
    responseBox.innerText = "‚è≥ Processing Order...";
    responseBox.classList.remove("d-none");

    fetch("/trade/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        console.log("üîç Server Response:", data);  // Debugging

        if (data.error) {
            responseBox.className = "alert alert-danger mt-3";
            responseBox.innerText = `‚ùå ${data.error}`;
        } else {
            responseBox.className = "alert alert-success mt-3";
            responseBox.innerText = `‚úÖ ${data.message}`;
        }

        setTimeout(() => responseBox.classList.add("d-none"), 3000);

        loadUserData();
        loadOrderBook();
    })
    .catch(error => {
        responseBox.className = "alert alert-danger mt-3";
        responseBox.innerText = "‚ùå An unexpected error occurred. Check the console for details.";
        console.error("üö® Fetch Error:", error);
        setTimeout(() => responseBox.classList.add("d-none"), 3000);
    });
});


    </script>

</body>
</html>
