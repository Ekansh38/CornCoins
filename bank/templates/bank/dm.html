{% extends "base.html" %}
{% block content %}

<div class="container-fluid mt-4">
    <h2 class="text-center text-dark fw-bold">ðŸ’¬ Direct Messages</h2>

    <!-- âœ… Start New DM Button -->
    <div class="text-center mb-3">
        <a href="/dm/start/" class="btn btn-primary btn-lg shadow-sm">âž• Start a New DM</a>
    </div>

    <div class="row">
        <!-- âœ… Sidebar with DM Contacts (Left Column) -->
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="text-center">Chats</h4>
                    <ul class="list-group list-group-flush overflow-auto" style="max-height: 70vh;" id="dm-contacts">
                        {% for partner in dm_partners %}
                        <li class="list-group-item dm-contact" data-user="{{ partner.id }}">
                            <strong>{{ partner.name }}</strong>
                        </li>
                        {% empty %}
                        <li class="list-group-item text-center">No chats available.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>

        <!-- âœ… Main Chat Window (Center Column) -->
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <h4 class="text-center" id="chat-header">Select a chat</h4>
                    <div class="chat-box flex-grow-1 overflow-auto p-3" id="chat-box" style="max-height: 70vh;">
                        <ul class="list-group chat-messages" id="dm-messages"></ul>
                    </div>
                    <!-- âœ… Chat Input -->
                    <div class="mt-3">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
                        <button class="btn btn-success mt-2 w-100" id="send-btn" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- âœ… Global Chat (Right Column) -->
        <div class="col-md-3">
            <div class="card shadow-sm h-100">
                <div class="card-body d-flex flex-column">
                    <h4 class="text-center fw-bold">ðŸŒŽ Global Chat (Anouncements)</h4>
                    <ul class="list-group flex-grow-1 overflow-auto" id="global-chat" style="max-height: 70vh;">
                        {% for message in global_messages %}
                        <li class="list-group-item">
                            <strong>{{ message.sender.name }}</strong>: {{ message.content }}
                        </li>
                        {% endfor %}
                    </ul>
                    <input type="text" id="global-input" class="form-control mt-2" placeholder="Type a message...">
                    <button class="btn btn-primary mt-2 w-100" id="global-btn">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>

#dm-messages {
    overflow-y: auto;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
}


.bank-transfer {
    background-color: #fff3cd !important;
    border-left: 5px solid #ffcc00;
    font-weight: bold;
}

    /* âœ… Make the chat layout as big as possible */
    .container-fluid {
        max-width: 95vw;
    }
    .chat-box {
        background: #f9f9f9;
        border-radius: 8px;
    }
    .dm-contact {
        cursor: pointer;
        padding: 10px;
        transition: background 0.3s;
    }
    .dm-contact:hover {
        background-color: #f1f1f1;
    }
    .message {
        padding: 10px 15px;
        border-radius: 15px;
        margin-bottom: 10px;
        max-width: 75%;
    }
    .message.sent {
        background: #dcf8c6;
        text-align: right;
    }
    .message.received {
        background: #fff;
        border: 1px solid #ddd;
    }
</style>

<!-- âœ… JavaScript -->
<script>




let selectedUser = null;
let lastMessageTimestamp = null;

// âœ… Handle DM Contact Click
document.querySelectorAll(".dm-contact").forEach(item => {
    item.addEventListener("click", function() {
        selectedUser = this.dataset.user;
        document.getElementById("chat-header").innerText = "Chat with " + this.innerText;
        document.getElementById("dm-messages").innerHTML = "";
        document.getElementById("send-btn").disabled = false;
        document.getElementById("chat-input").disabled = false;
        
        document.querySelectorAll(".dm-contact").forEach(c => c.classList.remove("active"));
        this.classList.add("active");

        loadMessages();
    });
});

// âœ… Auto-Check for New Messages Every Second
setInterval(() => {
    if (selectedUser) {
        loadMessages();
    }
}, 1000);

// âœ… Load Messages for Selected Chat
// âœ… Load Messages for Selected Chat
// âœ… Load Messages for Selected Chat
function loadMessages() {
    if (!selectedUser) return;

    fetch(`/dm/history/${selectedUser}/`)
    .then(response => response.json())
    .then(data => {
        let messageList = document.getElementById("dm-messages");
        messageList.innerHTML = "";

        if (!data.messages || data.messages.length === 0) {
            messageList.innerHTML = "<p class='text-center text-muted'>No messages yet.</p>";
            return;
        }


        data.messages.forEach(msg => {
            let messageItem = document.createElement("li");
            messageItem.className = `list-group-item ${msg.sender === "{{ request.user.name }}" ? 'sent' : 'received'}`;


            // âœ… If it's a bank transfer, apply Bootstrap warning style
            if (msg.is_bank_transfer) {
		messageItem.classList.add("bg-warning", "text-dark")
                messageItem.innerHTML = `<strong>(OFFICAL)</strong> ${msg.content}`;

            } else {
                messageItem.innerHTML = `<strong>${msg.sender}</strong>: ${msg.content}`;
            }

            messageList.appendChild(messageItem);
        });



	            if (autoScroll) {
            setTimeout(() => {
                messageList.scrollTo({
                    top: messageList.scrollHeight + 500,  // Scroll slightly past the last message
                    behavior: "smooth"  // Enable smooth scrolling
                });
            }, 50);
        }



	    })
	    .catch(error => {
		console.error("Error loading messages:", error);
	    });
	}




	let autoScroll = true; 

	let messageList = document.getElementById("dm-messages");

	messageList.addEventListener("scroll", function() {
	    if (messageList.scrollTop + messageList.clientHeight < messageList.scrollHeight - 10) {
		autoScroll = false;
	    } else {
		autoScroll = true;
	    }
	});



	// âœ… Send Direct Message
	document.getElementById("send-btn").addEventListener("click", function() {
	    sendMessage();
	});

	// âœ… Send on Enter Key
	document.getElementById("chat-input").addEventListener("keypress", function(event) {
	    if (event.key === "Enter") {
		sendMessage();
	    }
	});

	// âœ… Send Message Function
	function sendMessage() {
	    autoScroll = true
	    let content = document.getElementById("chat-input").value.trim();
	    if (!selectedUser || !content) return;

	    fetch("/dm/send/", {
		method: "POST",
		body: JSON.stringify({ receiver_id: selectedUser, content: content }),
		headers: { "Content-Type": "application/json" }
	    })
	    .then(response => response.json())
	    .then(() => {
		document.getElementById("chat-input").value = "";
		loadMessages(); // Refresh messages
	    })
	    .catch(error => console.error("Error sending message:", error));
	}

	// âœ… Send Global Message
	document.getElementById("global-btn").addEventListener("click", function() {
	    let content = document.getElementById("global-input").value.trim();
	    if (!content) return;

	    fetch("/global/send/", {
		method: "POST",
		body: JSON.stringify({ content: content }),
		headers: { "Content-Type": "application/json" }
	    })
	    .then(() => {
		document.getElementById("global-input").value = "";
	    });
	});


function scrollToLastMessage() {
    let messageList = document.getElementById("dm-messages");
    if (!messageList) {
        console.error("Chat messages container not found!");
        return;
    }
    
    console.log("Forcing scroll within chat box...");
    messageList.style.scrollBehavior = "auto"; 
    requestAnimationFrame(() => {
        messageList.scrollTop = messageList.scrollHeight;
        setTimeout(() => {
            messageList.scrollTop = messageList.scrollHeight;
        }, 10);
    });
}



document.addEventListener("DOMContentLoaded", function() {
    let urlParams = new URLSearchParams(window.location.search);
    let openChatId = urlParams.get("open_chat");
    if (openChatId) {
        document.querySelector(`[data-user="${openChatId}"]`).click();
    }
});




</script>

{% endblock %}
